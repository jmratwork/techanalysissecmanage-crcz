# PowerShell script to load malware simulation
param(
    [string]$SimulationScript = "benign_malware_simulator.ps1",
    [string]$Controller = "localhost"
)

# To prepare for offline use, predownload required modules:
#   Save-Module -Name PowerShellGet,PackageManagement -Path /opt/offline/psmodules
# The script will try to install modules from this location if online installation fails.

$offlineModulePath = "/opt/offline/psmodules"
Write-Host "Installing required modules..."
try {
    if (-not (Get-Command Invoke-WebRequest -ErrorAction SilentlyContinue)) {
        Install-PackageProvider -Name NuGet -Force -ErrorAction Stop | Out-Null
        Install-Module -Name PowerShellGet -Force -ErrorAction Stop | Out-Null
    }
} catch {
    Write-Warning "Failed to install PowerShell modules online: $_"
    if (Test-Path $offlineModulePath) {
        Write-Host "Attempting to load modules from $offlineModulePath"
        try {
            Import-Module (Join-Path $offlineModulePath 'PackageManagement') -Force -ErrorAction Stop
            Import-Module (Join-Path $offlineModulePath 'PowerShellGet') -Force -ErrorAction Stop
        } catch {
            Write-Error "Failed to load modules from offline cache: $_"
        }
    }
}

if (Test-Path $SimulationScript) {
    Write-Host "Running simulation against $Controller"
    & $SimulationScript -Controller $Controller
} else {
    Write-Error "Simulation script '$SimulationScript' not found."
}
